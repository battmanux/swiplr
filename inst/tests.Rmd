---
title: "LogEx"
author: "Emmanuel BATT"
date: "11/06/2019"
output: html_document
---

```{r setup}
library(swiplr)
#options(swipl_bin_folder = "")
```

# Simple usage

## returns bool

```{prolog}

bar.
foo(bar).

?- bar.
?- foo(bar).
?- foo(boom).
```


## With data.frame as result

```{prolog}

maman(claire).
maman(marieOdile).
a_maman(emmanuel, marieOdile).
a_maman(matthew, claire).
a_maman(célestine, claire).

est_enfant(X, Y) :- a_maman(X, Y).
a_frère(X1, X2)  :- a_maman(X1, Y), a_maman(X2, Y), dif(X1,X2).

?- a_frère(SIBLING_1, SIBLING_2) 
```


## hide columns

You can add _ at the end of a variable to remove it from results

```{prolog}

maman(claire).
maman(marieOdile).
a_maman(emmanuel, marieOdile).
a_maman(matthew, claire).
a_maman(célestine, claire).

est_enfant(X, Y) :- a_maman(X, Y).
a_frère(X1, X2)  :- a_maman(X1, Y), a_maman(X2, Y), dif(X1,X2).

?- a_frère(SIBLING, _) 
?- a_frère(SIBLING_, WHO), a_maman(SIBLING_, MUM) 
?- a_frère(SIBLING_, WHO) 
```

# Exchange data with R

```{r}

r_to_pro <- function(data_in) {
  lapply(seq(nrow(data_in)), function(i) {
    l_out <- as.list(data_in[i,])
    names(l_out) <- gsub("\\.", "_", names(l_out))
    return(l_out)
    })
}
  
some_name <- "john"
value_list <- paste0("bar_", 1:3)

named_list <- list(
  var1 = list(
    field1 = "sömé_àçênts", 
    field2 = 66), 
  var2 = "bar0")

some_table <- r_to_pro(iris[sample(1:150, 4),])

```

One can use  `whisker::whisker.render` syntax.

```{prolog}

% Inject the content of R some_name variable
foo({{ some_name }}).

foo({{ named_list.var1.field1 }}).

% Iterates through the list of values in R value_list vector
{{#value_list}}
  foo({{.}}).
{{/value_list}}

% Iterate through a table (list of rows)
{{#some_table}}
  some_table({{Species}},{{Sepal_Length}},{{Sepal_Width}}).
{{/some_table}}

?- foo(FOO)
?- some_table(Species, Sepal_Length, Sepal_Width)
```

And then get back values in R

```{r}

names(prolog_output)

prolog_output$result_1

```



# Degraded modes

## Infinite loop

```{prolog, timeout=1}

s1(A) :- s2(A).
s2(A) :- s1(A).

?- s1(X)
```

# Advances features

## external library

change interpreter path
```{r}
options(swipl_bin_folder = "/usr/local/bin/")
```

use local library
```{prolog}

:- use_module(library(pita)).
:- pita.

:- begin_lpad.

visage_type(homme):0.5; visage_type(femme):0.5.
presence_ride(oui):0.4; presence_ride(non):0.6.

age(enfant):0/10 ; age(ado):0/10 ; age(adulte):10/10 :- 
  visage_type(homme), presence_ride(non).
age(enfant):1/10 ; age(ado):3/10 ; age(adulte):6/10 :- 
  visage_type(homme), presence_ride(oui).
age(enfant):3/10 ; age(ado):3/10 ; age(adulte):3/10  :- 
  visage_type(femme).

:- end_lpad.

?- prob(visage_type(X), age(enfant), P)
```

```{prolog mc_var}
:- use_module(library(mcintyre)).
:- mc.
:- begin_lpad.

val(I,X) :-
  mean(M),
  val(I,M,X).
% at time I we see X sampled from a Gaussian with mean M and variamce 2.0

mean(M): user(M,gauss(1.0, 5.0)).
% Gaussian distribution of the mean of the Gaussian of the variable

val(_,M,X): user(X,gauss(M, 2.0)).
% Gaussian distribution of the variable


:- end_lpad.

gauss(Mean,Variance,S):-
  number(Mean),!,
  random(U1),
  random(U2),
  R is sqrt(-2*log(U1)),
  Theta is 2*pi*U2,
  S0 is R*cos(Theta),
  StdDev is sqrt(Variance),
  S is StdDev * S0 + Mean.

?- mc_sample_arg(val(0,X_),30,X_,L0)
```

```{r}
vect <- eval(parse(text = as.character(mc_var$L0)))
hist(vect)
```

# Other

# variables with first upper case letter

```{prolog}

are(B, B, []).
are(A, _, T)  :- not(memberchk(X, T)), are(A, X, [X|T]).

has(A, B) :- has(A, X), has(X, B).

has(human, age).
has(bob, children(john)).

age(mike, 33).
age(bob, 34).

is_a(mike, human).
is_a(bob, human).
is_a(john, children(bob)).

are(children(bob), human_child).
are(X, human_adult) :- is_a(X, human), age(X, AGE), AGE > 18.

?- is_a(Class, Super)
?- are(WHO, WHAT)
?- is_a(Class, Super), are(Super, WHAT)
```

